---
- name: Deploy certmanager (k8s/helm)
  hosts: localhost
  become: true
  vars:
    domain_zone_staging: "{{ lookup('env', 'DOMAIN_ZONE_STAGING') | default(algorisma.com) }}"
    domain_zone_prod: "{{ lookup('env', 'DOMAIN_ZONE_PROD') | default(algorisma.com) }}"
    cf_token_prod: "{{ lookup('env', 'CF_TOKEN_PROD') }}"
    cf_token_staging: "{{ lookup('env', 'CF_TOKEN_STAGING') }}"
  tasks:
    - name: Add / Update certmanager helm repo
      ansible.builtin.shell: |
        helm repo add jetstack https://charts.jetstack.io
        helm repo update

        exit 0
    
    - name: Create Namespace (if doesn't exist)
      ansible.builtin.shell: |
        tmpNamespace="cert-manager" && kubectl get namespace | grep -q "^$tmpNamespace " || kubectl create namespace $tmpNamespace

        exit 0
    - name: Install CRD(s)
      ansible.builtin.shell: |
        kubectl --kubeconfig=../../k8s-home.yaml apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.1/cert-manager.crds.yaml

        exit 0
    - name: Install/upgrade chart
      ansible.builtin.shell: |
        helm upgrade -i cert-manager jetstack/cert-manager --namespace cert-manager --values=cert-values.yaml --version v1.13.1
        
        exit 0
    - name: Create certificate issuers manifest
      template:
        src: manifests/issuer.yaml.j2
        dest: /tmp/issuer.yaml
        mode: '0644'

    - name: Apply certificate issuers manifest
      ansible.builtin.shell: |
        kubectl --kubeconfig=../../k8s-home.yaml apply -f /tmp/issuer.yaml
        
        exit 0
    - name: Create resolver/api manifest
      template:
        src: manifests/resolver_api.yaml.j2
        dest: /tmp/resolver_api.yaml
        mode: '0644'

    - name: Apply resolver/api manifest
      ansible.builtin.shell: |
        kubectl --kubeconfig=../../k8s-home.yaml apply -f /tmp/resolver_api.yaml
        
        exit 0    
    - name: Create local certs manifest
      template:
        src: manifests/local_certs.yaml.j2
        dest: /tmp/local_certs.yaml
        mode: '0644'

    - name: Apply local certs manifest
      ansible.builtin.shell: |
        kubectl --kubeconfig=../../k8s-home.yaml apply -f /tmp/local_certs.yaml
        
        exit 0